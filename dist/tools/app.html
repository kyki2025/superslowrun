<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>超慢跑助手</title>
    <link rel="stylesheet" href="../styles/app.css">
</head>
<body>
    <div class="app-container">
        <!-- 头部区域 -->
        <div class="app-header">
            <div class="app-logo">
                <div class="logo-icon">♪</div>
            </div>
            <h1 class="app-title">超慢跑助手</h1>
            <p class="app-subtitle">科学节拍，智能运动</p>
        </div>

        <!-- 步频控制卡片 -->
        <div class="module-card">
            <div class="card-header">
                <span class="card-icon">⚡</span>
                <span class="card-title">步频控制</span>
            </div>
            <div class="bpm-section">
                <div class="bpm-controls">
                    <button class="bpm-btn decrease" id="bpm-decrease">-</button>
                    <div class="bpm-display">
                        <div class="bpm-number" id="bpm-value">180</div>
                        <div class="bpm-unit">步/分</div>
                        <div class="bpm-range">范围: 100-300</div>
                        <div class="bpm-status" id="bpm-status">中等强度</div>
                        <div class="custom-bpm-wrap">
                            <label class="custom-label">自定义步频（100-300）</label>
                            <input type="number" id="custom-bpm" placeholder="180" min="100" max="300" value="180">
                        </div>
                    </div>
                    <button class="bpm-btn increase" id="bpm-increase">+</button>
                </div>
                <div class="preset-buttons">
                    <button class="preset-btn" data-bpm="170">170</button>
                    <button class="preset-btn active" data-bpm="180">180</button>
                    <button class="preset-btn" data-bpm="190">190</button>
                </div>
                <div class="bpm-tip">
                    <span class="tip-icon">✓</span>
                    <span class="tip-text">超慢跑最佳节奏（170-190 步/分钟）</span>
                </div>
            </div>
        </div>

        <!-- 节拍器卡片 -->
        <div class="module-card">
            <div class="card-header">
                <span class="card-icon">🎵</span>
                <span class="card-title">节拍器</span>
            </div>
            <div class="metronome-section">
                <div class="metronome-display">
                    <div class="metronome-circle" id="metronome-circle">
                        <div class="metronome-dot"></div>
                    </div>
                    <div class="metronome-info">
                        <div class="metronome-bpm" id="metronome-bpm">180</div>
                        <div class="metronome-unit">BPM</div>
                        <div class="status-badges">
                            <span class="badge purple">单次: 0:00</span>
                            <span class="badge green">当前音效: 点击</span>
                        </div>
                        <div class="metronome-status" id="metronome-status">点击播放</div>
                    </div>
                </div>
                <button class="play-button" id="metronome-toggle">
                    <span class="play-icon">▶</span>
                </button>
                <div class="volume-section">
                    <div class="volume-control">
                        <span class="volume-icon">🔊</span>
                        <input type="range" class="volume-slider" id="volume-slider" min="0" max="100" value="65">
                        <span class="volume-percent" id="volume-percent">65%</span>
                        <span class="volume-text">音量调节</span>
                    </div>
                </div>
                <div class="sound-selector">
                    <span class="selector-label">节拍音效</span>
                    <div class="sound-buttons">
                        <button class="sound-btn" data-sound="beep">哔哔</button>
                        <button class="sound-btn" data-sound="tick">滴答</button>
                        <button class="sound-btn active" data-sound="click">点击</button>
                        <button class="sound-btn" data-sound="bell">铃声</button>
                        <button class="sound-btn" data-sound="drum">鼓点</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 跑步计时器卡片 -->
        <div class="module-card">
            <div class="card-header">
                <span class="card-icon">⏰</span>
                <span class="card-title">跑步计时器</span>
            </div>
            <div class="timer-section">
                <div class="timer-presets">
                    <span class="presets-label">快速选择时间</span>
                    <div class="preset-time-buttons">
                        <button class="time-btn" data-time="15">15分</button>
                        <button class="time-btn" data-time="30">30分</button>
                        <button class="time-btn" data-time="45">45分</button>
                        <button class="time-btn" data-time="60">60分</button>
                        <button class="time-btn" data-time="90">90分</button>
                        <button class="time-btn" data-time="120">120分</button>
                    </div>
                </div>
                <div class="custom-time">
                    <label class="custom-label">自定义时间（分钟）</label>
                    <input type="number" id="custom-minutes" placeholder="15" min="1" max="999" value="15">
                </div>
                <button class="start-button" id="start-exercise">
                    <span class="start-icon">▶</span>
                    <span class="start-text">开始跑步</span>
                </button>
                <div class="exercise-tips">
                    <div class="tip-item">
                        <span class="tip-emoji">🏃‍♂️</span>
                        <span>超慢跑是一种轻松的低强度有氧运动</span>
                    </div>
                    <div class="tip-item">
                        <span class="tip-emoji">💚</span>
                        <span>建议心率保持在最大心率的60-70%</span>
                    </div>
                    <div class="tip-item">
                        <span class="tip-emoji">⏰</span>
                        <span>建议每次运动15-60分钟，效果最佳</span>
                    </div>
                    <div class="tip-item">
                        <span class="tip-emoji">🌟</span>
                        <span>坚持每周3-5次运动，养成健康习惯</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 运动统计卡片 -->
        <div class="module-card">
            <div class="card-header">
                <span class="card-icon">📊</span>
                <span class="card-title">运动统计</span>
            </div>
            <div class="stats-section">
                <div class="main-stats">
                    <div class="main-stat-item">
                        <div class="stat-value" id="today-time">16:00</div>
                        <div class="stat-label">今日运动时间</div>
                        <div class="stat-target">目标 27:00 本周</div>
                    </div>
                    <div class="main-stat-item">
                        <div class="stat-value calories" id="total-calories">2700</div>
                        <div class="stat-label">消耗卡路里</div>
                    </div>
                </div>
                <div class="mini-stats">
                    <div class="mini-stat">
                        <div class="mini-value" id="sessions-count">6</div>
                        <div class="mini-label">运动次数</div>
                    </div>
                    <div class="mini-stat">
                        <div class="mini-value" id="total-duration">34:58</div>
                        <div class="mini-label">运动总时长</div>
                    </div>
                    <div class="mini-stat">
                        <div class="mini-value" id="step-count">6738</div>
                        <div class="mini-label">总步数</div>
                    </div>
                    <div class="mini-stat">
                        <div class="mini-value" id="avg-cadence">180</div>
                        <div class="mini-label">平均步频</div>
                    </div>
                </div>
                <div class="recent-activities">
                    <h4 class="activities-title">最近记录</h4>
                    <div class="activity-list" id="activity-list">
                        <div class="activity-item">
                            <div class="activity-time">今天 08:34</div>
                            <div class="activity-duration">16:00</div>
                            <div class="activity-type">慢跑 · 中等强度</div>
                        </div>
                        <div class="activity-item">
                            <div class="activity-time">8月7日 20:30</div>
                            <div class="activity-duration">16:27</div>
                        </div>
                        <div class="activity-item">
                            <div class="activity-time">8月7日 17:29</div>
                            <div class="activity-duration">6:14</div>
                        </div>
                        <div class="activity-item">
                            <div class="activity-time">8月7日 17:06</div>
                            <div class="activity-duration">5:52</div>
                            <div class="activity-type">慢跑 · 轻度有氧</div>
                        </div>
                        <div class="activity-item">
                            <div class="activity-time">8月7日 12:31</div>
                            <div class="activity-duration">6:14</div>
                            <div class="activity-type">慢跑 · 中等强度</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 底部信息 -->
        <div class="app-footer">
            <p>超慢跑 - 让健康运动成为生活习惯</p>
        </div>
    </div>

    <!-- 运动进行中的全屏覆盖层 -->
    <div class="exercise-overlay" id="exercise-overlay" style="display: none;">
        <div class="exercise-container">
            <div class="exercise-header">
                <h2>运动进行中</h2>
                <button class="close-btn" id="close-exercise">×</button>
            </div>
            <div class="exercise-timer">
                <div class="timer-circle">
                    <div class="timer-display" id="exercise-timer-display">15:00</div>
                    <div class="timer-label">剩余时间</div>
                </div>
            </div>
            <div class="exercise-info">
                <div class="info-row">
                    <div class="info-item">
                        <span class="info-label">当前步频</span>
                        <span class="info-value" id="current-cadence">180</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">已用时间</span>
                        <span class="info-value" id="elapsed-time">00:00</span>
                    </div>
                </div>
                <div class="info-row">
                    <div class="info-item">
                        <span class="info-label">预计步数</span>
                        <span class="info-value" id="estimated-steps">0</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">消耗热量</span>
                        <span class="info-value" id="burned-calories">0</span>
                    </div>
                </div>
            </div>
            <div class="exercise-controls">
                <button class="control-btn pause-btn" id="pause-exercise">暂停</button>
                <button class="control-btn stop-btn" id="stop-exercise">结束运动</button>
            </div>
        </div>
    </div>

    <script>
        // 超慢跑助手 - 内联版本避免模块冲突
        class SuperSlowRunCore {
            constructor() {
                this.config = {
                    defaultBPM: 180,
                    minBPM: 100,
                    maxBPM: 300,
                    defaultDuration: 15,
                    maxDuration: 999,
                    volumeDefault: 0.65
                };

                this.state = {
                    bpm: this.config.defaultBPM,
                    isMetronomeRunning: false,
                    isExerciseRunning: false,
                    exercisePaused: false,
                    currentDuration: this.config.defaultDuration,
                    elapsedTime: 0,
                    currentSound: 'click',
                    volume: this.config.volumeDefault,
                    metronomeAutoStarted: false
                };

                this.stats = {
                    totalSessions: 6,
                    totalTime: 35, // 兼容旧字段（分钟）
                    totalSeconds: 35 * 60,
                    totalSteps: 6738,
                    totalCalories: 2700,
                    averageBPM: 180,
                    weeklyTarget: 27 * 60,
                    todayTime: 16 * 60, // 秒
                    recentActivities: []
                };

                this.timers = {
                    metronome: null,
                    exercise: null,
                    stats: null
                };

                this.audioContext = null;
                this.audioBuffer = null;
                this.initAudio();
                this.loadData();
            }

            async initAudio() {
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    this.soundConfigs = {
                        beep: { frequency: 800, duration: 0.1, wave: 'sine' },
                        tick: { frequency: 1000, duration: 0.05, wave: 'square' },
                        click: { frequency: 1200, duration: 0.08, wave: 'triangle' },
                        bell: { frequency: 600, duration: 0.2, wave: 'sine' },
                        drum: { frequency: 100, duration: 0.15, wave: 'sawtooth' }
                    };
                } catch (error) {
                    console.warn('音频初始化失败:', error);
                }
            }

            playMetronomeSound() {
                if (!this.audioContext || this.state.volume === 0) return;
                try {
                    const config = this.soundConfigs[this.state.currentSound] || this.soundConfigs.click;
                    const oscillator = this.audioContext.createOscillator();
                    const gainNode = this.audioContext.createGain();
                    oscillator.connect(gainNode);
                    gainNode.connect(this.audioContext.destination);
                    oscillator.frequency.setValueAtTime(config.frequency, this.audioContext.currentTime);
                    oscillator.type = config.wave;
                    gainNode.gain.setValueAtTime(0, this.audioContext.currentTime);
                    gainNode.gain.linearRampToValueAtTime(this.state.volume, this.audioContext.currentTime + 0.01);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + config.duration);
                    oscillator.start(this.audioContext.currentTime);
                    oscillator.stop(this.audioContext.currentTime + config.duration);
                } catch (error) {
                    console.warn('音效播放失败:', error);
                }
            }

            startMetronome() {
                if (this.state.isMetronomeRunning) return;
                if (this.audioContext && this.audioContext.state === 'suspended') {
                    this.audioContext.resume();
                }
                this.state.isMetronomeRunning = true;
                const interval = 60000 / this.state.bpm;
                this.timers.metronome = setInterval(() => {
                    if (this.state.isMetronomeRunning) {
                        this.playMetronomeSound();
                        this.triggerMetronomeVisual();
                    }
                }, interval);
                console.log(`节拍器已启动 - BPM: ${this.state.bpm}`);
            }

            stopMetronome() {
                this.state.isMetronomeRunning = false;
                if (this.timers.metronome) {
                    clearInterval(this.timers.metronome);
                    this.timers.metronome = null;
                }
                console.log('节拍器已停止');
            }

            triggerMetronomeVisual() {
                const circle = document.getElementById('metronome-circle');
                if (circle) {
                    circle.classList.add('active');
                    setTimeout(() => circle.classList.remove('active'), 100);
                }
            }

            setBPM(newBPM) {
                newBPM = Math.max(this.config.minBPM, Math.min(this.config.maxBPM, parseInt(newBPM)));
                this.state.bpm = newBPM;
                if (this.state.isMetronomeRunning) {
                    this.stopMetronome();
                    this.startMetronome();
                }
                this.updateBPMDisplay();
                this.saveData();
                console.log(`BPM已设置为: ${newBPM}`);
            }

            updateBPMDisplay() {
                const elements = ['bpm-value', 'metronome-bpm', 'current-cadence'];
                elements.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) element.textContent = this.state.bpm;
                });
                const statusElement = document.getElementById('bpm-status');
                if (statusElement) {
                    if (this.state.bpm <= 175) statusElement.textContent = '轻度强度';
                    else if (this.state.bpm <= 185) statusElement.textContent = '中等强度';
                    else statusElement.textContent = '高等强度';
                }
            }

            updateStatsDisplay() {
                const todayElement = document.getElementById('today-time');
                if (todayElement) {
                    const tsec = Math.max(0, this.stats.todayTime || 0);
                    const minutes = Math.floor(tsec / 60);
                    const seconds = tsec % 60;
                    todayElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                }
                const caloriesElement = document.getElementById('total-calories');
                if (caloriesElement) caloriesElement.textContent = Math.floor(this.stats.totalCalories).toString();
                const totalSec = (this.stats.totalSeconds != null) ? this.stats.totalSeconds : Math.round((this.stats.totalTime || 0) * 60);
                const statsElements = {
                    'sessions-count': this.stats.totalSessions,
                    'total-duration': this.formatDuration(totalSec),
                    'step-count': this.stats.totalSteps,
                    'avg-cadence': this.stats.averageBPM
                };
                Object.entries(statsElements).forEach(([id, value]) => {
                    const element = document.getElementById(id);
                    if (element) element.textContent = value.toString();
                });
                this.renderRecentActivities();
            }

            renderRecentActivities() {
                const list = document.getElementById('activity-list');
                if (!list) return;
                const records = (this.stats.recentActivities || []).slice(0, 5);
                if (!records.length) return; // 若无记录，保留原始示例
                list.innerHTML = records.map(r => {
                    const d = new Date(r.ts || Date.now());
                    const month = d.getMonth() + 1;
                    const day = d.getDate();
                    const hh = String(d.getHours()).padStart(2, '0');
                    const mm = String(d.getMinutes()).padStart(2, '0');
                    const duration = this.formatSeconds ? this.formatSeconds(r.durationSec || 0) : `${Math.floor((r.durationSec||0)/60)}:${String((r.durationSec||0)%60).padStart(2,'0')}`;
                    const bpm = r.bpm || this.state.bpm;
                    return `
                        <div class="activity-item">
                            <div class="activity-time">${month}月${day}日 ${hh}:${mm}</div>
                            <div class="activity-duration">${duration}</div>
                            <div class="activity-type">${bpm} BPM · ${r.steps||0}步 · 卡路里 ${r.calories||0}</div>
                        </div>
                    `;
                }).join('');
            }

            formatTime(minutes) {
                if (minutes < 60) return `${minutes}:00`;
                const hours = Math.floor(minutes / 60);
                const mins = minutes % 60;
                return `${hours}:${mins.toString().padStart(2, '0')}`;
            }

            formatDuration(seconds) {
                const sec = Math.max(0, Math.round(seconds));
                if (sec < 3600) {
                    const m = Math.floor(sec / 60);
                    const s = sec % 60;
                    return `${m}:${s.toString().padStart(2, '0')}`;
                }
                const h = Math.floor(sec / 3600);
                const m = Math.floor((sec % 3600) / 60);
                return `${h}:${m.toString().padStart(2, '0')}`;
            }

            saveData() {
                try {
                    const data = { state: this.state, stats: this.stats, timestamp: Date.now() };
                    localStorage.setItem('superslowrun_data', JSON.stringify(data));
                } catch (error) {
                    console.warn('保存数据失败:', error);
                }
            }

            loadData() {
                try {
                    const saved = localStorage.getItem('superslowrun_data');
                    if (saved) {
                        const data = JSON.parse(saved);
                        if (data.state) {
                            Object.assign(this.state, data.state);
                            this.state.isMetronomeRunning = false;
                            this.state.isExerciseRunning = false;
                        }
                        if (data.stats) Object.assign(this.stats, data.stats);
                    }
                } catch (error) {
                    console.warn('加载数据失败:', error);
                }
            }
        }

        class SuperSlowRunApp {
            constructor() {
                this.core = new SuperSlowRunCore();
                this.init();
            }

            init() {
                console.log('🏃‍♂️ 超慢跑助手应用初始化中...');
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', () => this.onDOMReady());
                } else {
                    this.onDOMReady();
                }
            }

            onDOMReady() {
                this.bindEvents();
                this.updateAllDisplays();
                this.startPageAnimations();
                console.log('✅ 超慢跑助手应用初始化完成');
            }

            bindEvents() {
                // BPM控制事件
                const decreaseBtn = document.getElementById('bpm-decrease');
                const increaseBtn = document.getElementById('bpm-increase');
                if (decreaseBtn) {
                    decreaseBtn.addEventListener('click', () => {
                        const newBPM = this.core.state.bpm - 5;
                        this.core.setBPM(newBPM);
                        this.updatePresetButtons();
                    });
                }
                if (increaseBtn) {
                    increaseBtn.addEventListener('click', () => {
                        const newBPM = this.core.state.bpm + 5;
                        this.core.setBPM(newBPM);
                        this.updatePresetButtons();
                    });
                }

                // BPM预设按钮
                document.querySelectorAll('.preset-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const bpm = parseInt(btn.dataset.bpm);
                        if (Number.isFinite(bpm)) {
                            this.core.setBPM(bpm);
                            const input = document.getElementById('custom-bpm');
                            if (input) input.value = String(this.core.state.bpm);
                            this.updatePresetButtons();
                        }
                    });
                });

                // 自定义步频输入
                const customBpm = document.getElementById('custom-bpm');
                if (customBpm) {
                    const onBpmInput = () => {
                        let v = parseInt(customBpm.value || '0');
                        if (!Number.isFinite(v)) v = this.core.state.bpm;
                        v = Math.max(this.core.config.minBPM, Math.min(this.core.config.maxBPM, v));
                        this.core.setBPM(v);
                        customBpm.value = String(this.core.state.bpm);
                        this.updatePresetButtons();
                    };
                    customBpm.addEventListener('change', onBpmInput);
                    customBpm.addEventListener('blur', onBpmInput);
                    customBpm.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') { e.preventDefault(); onBpmInput(); }
                    });
                }

                // 节拍器播放按钮
                const toggleBtn = document.getElementById('metronome-toggle');
                if (toggleBtn) {
                    toggleBtn.addEventListener('click', () => {
                        this.toggleMetronome();
                    });
                }

                // 音量滑块
                const volumeSlider = document.getElementById('volume-slider');
                const volumePercent = document.getElementById('volume-percent');
                if (volumeSlider) {
                    volumeSlider.addEventListener('input', (e) => {
                        const volume = parseFloat(e.target.value) / 100;
                        this.core.state.volume = volume;
                        if (volumePercent) volumePercent.textContent = `${Math.round(volume * 100)}%`;
                    });
                    volumeSlider.value = this.core.state.volume * 100;
                    if (volumePercent) volumePercent.textContent = `${Math.round(this.core.state.volume * 100)}%`;
                }

                // 音效选择按钮
                document.querySelectorAll('.sound-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const soundType = btn.dataset.sound;
                        if (soundType && this.core.soundConfigs[soundType]) {
                            this.core.state.currentSound = soundType;
                            this.updateSoundButtons();
                            const badge = document.querySelector('.badge.green');
                            if (badge) badge.textContent = `当前音效: ${btn.textContent.trim()}`;
                            this.core.playMetronomeSound();
                        }
                    });
                });

                // 计时器预设
                document.querySelectorAll('.time-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const mins = parseInt(btn.dataset.time);
                        if (mins) {
                            this.core.state.currentDuration = mins;
                            const input = document.getElementById('custom-minutes');
                            if (input) input.value = String(mins);
                            this.updateTimeButtons();
                        }
                    });
                });

                // 自定义时间输入
                const customInput = document.getElementById('custom-minutes');
                if (customInput) {
                    const onInput = () => {
                        let v = parseInt(customInput.value || '0');
                        if (!Number.isFinite(v)) v = this.core.config.defaultDuration;
                        v = Math.max(1, Math.min(this.core.config.maxDuration, v));
                        this.core.state.currentDuration = v;
                        this.updateTimeButtons();
                    };
                    customInput.addEventListener('input', onInput);
                    customInput.addEventListener('change', onInput);
                }

                // 开始/暂停/结束/关闭
                const startBtn = document.getElementById('start-exercise');
                if (startBtn) startBtn.addEventListener('click', () => this.startExercise());
                const pauseBtn = document.getElementById('pause-exercise');
                if (pauseBtn) pauseBtn.addEventListener('click', () => this.pauseExercise());
                const stopBtn = document.getElementById('stop-exercise');
                if (stopBtn) stopBtn.addEventListener('click', () => this.stopExercise(true));
                const closeBtn = document.getElementById('close-exercise');
                if (closeBtn) closeBtn.addEventListener('click', () => this.stopExercise(false));

                // 空格键控制节拍器
                document.addEventListener('keydown', (e) => {
                    if (e.code === 'Space' && !e.target.matches('input')) {
                        e.preventDefault();
                        this.toggleMetronome();
                    }
                });
            }

            toggleMetronome() {
                if (this.core.state.isMetronomeRunning) {
                    this.core.stopMetronome();
                } else {
                    this.core.startMetronome();
                }
                this.updateMetronomeUI();
            }

            updateAllDisplays() {
                this.core.updateBPMDisplay();
                this.core.updateStatsDisplay();
                this.updateMetronomeUI();
                this.updatePresetButtons();
                this.updateSoundButtons();
                this.updateTimeButtons();
                this.updateExerciseUI();
            }

            updateMetronomeUI() {
                const toggleBtn = document.getElementById('metronome-toggle');
                const statusElement = document.getElementById('metronome-status');
                const playButton = document.querySelector('.play-button');
                
                if (this.core.state.isMetronomeRunning) {
                    if (toggleBtn) toggleBtn.textContent = '⏸';
                    if (playButton) {
                        playButton.classList.add('playing');
                        playButton.innerHTML = '<span class="play-icon">⏸</span>';
                    }
                    if (statusElement) statusElement.textContent = '正在播放';
                } else {
                    if (toggleBtn) toggleBtn.textContent = '▶';
                    if (playButton) {
                        playButton.classList.remove('playing');
                        playButton.innerHTML = '<span class="play-icon">▶</span>';
                    }
                    if (statusElement) statusElement.textContent = '点击播放';
                }
            }

            updatePresetButtons() {
                document.querySelectorAll('.preset-btn').forEach(btn => {
                    const bpm = parseInt(btn.dataset.bpm);
                    if (bpm === this.core.state.bpm) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });
            }

            updateSoundButtons() {
                document.querySelectorAll('.sound-btn').forEach(btn => {
                    const sound = btn.dataset.sound;
                    if (sound === this.core.state.currentSound) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });
            }

            startPageAnimations() {
                const cards = document.querySelectorAll('.module-card');
                cards.forEach((card, index) => {
                    card.style.opacity = '0';
                    card.style.transform = 'translateY(20px)';
                    setTimeout(() => {
                        card.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
                        card.style.opacity = '1';
                        card.style.transform = 'translateY(0)';
                    }, index * 150);
                });
            }

            // ============ 计时器与运动逻辑 ============
            updateTimeButtons() {
                const mins = this.core.state.currentDuration;
                document.querySelectorAll('.time-btn').forEach(b => {
                    const v = parseInt(b.dataset.time);
                    if (v === mins) b.classList.add('active'); else b.classList.remove('active');
                });
            }

            startExercise() {
                if (this.core.state.isExerciseRunning) return;
                this.core.state.isExerciseRunning = true;
                this.core.state.exercisePaused = false;
                this.core.state.elapsedTime = 0;
                const overlay = document.getElementById('exercise-overlay');
                if (overlay) overlay.style.display = 'flex';
                // 自动启动节拍器（若当前未运行），用于运动中发声
                if (!this.core.state.isMetronomeRunning) {
                    this.core.state.metronomeAutoStarted = true;
                    this.core.startMetronome();
                } else {
                    this.core.state.metronomeAutoStarted = false;
                }
                this.updateExerciseUI();
                this.core.timers.exercise = setInterval(() => {
                    if (!this.core.state.isExerciseRunning || this.core.state.exercisePaused) return;
                    this.core.state.elapsedTime += 1;
                    const durationSec = this.core.state.currentDuration * 60;
                    if (this.core.state.elapsedTime >= durationSec) {
                        this.stopExercise(true);
                        return;
                    }
                    this.updateExerciseUI();
                }, 1000);
            }

            pauseExercise() {
                if (!this.core.state.isExerciseRunning) return;
                this.core.state.exercisePaused = !this.core.state.exercisePaused;
                const pauseBtn = document.getElementById('pause-exercise');
                if (pauseBtn) pauseBtn.textContent = this.core.state.exercisePaused ? '继续' : '暂停';
                // 暂停时如果是自动启动的节拍器则停止，继续时再恢复
                if (this.core.state.metronomeAutoStarted) {
                    if (this.core.state.exercisePaused) this.core.stopMetronome();
                    else this.core.startMetronome();
                }
            }

            stopExercise(saveStats) {
                if (this.core.timers.exercise) {
                    clearInterval(this.core.timers.exercise);
                    this.core.timers.exercise = null;
                }
                const overlay = document.getElementById('exercise-overlay');
                if (overlay) overlay.style.display = 'none';

                // 若运动期间我们自动启动了节拍器，则在结束时停止
                if (this.core.state.metronomeAutoStarted) {
                    this.core.stopMetronome();
                    this.core.state.metronomeAutoStarted = false;
                }

                if (saveStats) {
                    const actualSeconds = this.core.state.elapsedTime; // 实际运动时长
                    const steps = Math.round((this.core.state.bpm / 60) * actualSeconds);
                    const calories = Math.round((actualSeconds / 60) * 3);
                    this.core.stats.totalSessions += 1;
                    this.core.stats.totalSeconds = (this.core.stats.totalSeconds || 0) + actualSeconds;
                    this.core.stats.totalTime = Math.round(this.core.stats.totalSeconds / 60); // 兼容旧字段
                    this.core.stats.todayTime = (this.core.stats.todayTime || 0) + actualSeconds;
                    this.core.stats.totalSteps += steps;
                    this.core.stats.totalCalories += calories;
                    // 最近记录（保留5条）
                    this.core.stats.recentActivities = this.core.stats.recentActivities || [];
                    this.core.stats.recentActivities.unshift({
                        ts: Date.now(),
                        durationSec: actualSeconds,
                        bpm: this.core.state.bpm,
                        steps,
                        calories
                    });
                    this.core.stats.recentActivities = this.core.stats.recentActivities.slice(0, 5);
                    this.core.updateStatsDisplay();
                    this.core.saveData();
                }
                this.core.state.isExerciseRunning = false;
                this.core.state.exercisePaused = false;
                this.core.state.elapsedTime = 0;
                this.updateExerciseUI();
            }

            updateExerciseUI() {
                const durationSec = this.core.state.currentDuration * 60;
                const remain = Math.max(0, durationSec - this.core.state.elapsedTime);
                const display = document.getElementById('exercise-timer-display');
                if (display) display.textContent = this.formatSeconds(remain);
                const elapsedEl = document.getElementById('elapsed-time');
                if (elapsedEl) elapsedEl.textContent = this.formatSeconds(this.core.state.elapsedTime);
                const stepsEl = document.getElementById('estimated-steps');
                if (stepsEl) stepsEl.textContent = String(Math.round((this.core.state.bpm / 60) * this.core.state.elapsedTime));
                const calEl = document.getElementById('burned-calories');
                if (calEl) calEl.textContent = String(Math.round(this.core.state.elapsedTime * 0.05));
                const singleBadge = document.querySelector('.badge.purple');
                if (singleBadge) singleBadge.textContent = `单次: ${this.formatSeconds(this.core.state.elapsedTime)}`;
            }

            formatSeconds(sec) {
                const m = Math.floor(sec / 60);
                const s = sec % 60;
                return `${m}:${s.toString().padStart(2, '0')}`;
            }
        }

        // 启动应用
        document.addEventListener('DOMContentLoaded', () => {
            new SuperSlowRunApp();
            console.log('🎯 超慢跑助手应用启动完成');
        });
    </script>
</body>
</html>
